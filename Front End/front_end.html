<html>
<head>
  <meta charset="utf-8">

  <title>Wine About It</title>
  <meta name="author" content="Jen Lamere">

    <style type="text/css">
    .masthead   {
        height: 30%;
        background-color: #502127 !important;
    }
    #footer{
        background-color: #502127;
        height: 4%;
        position: fixed;
        bottom:0px;
        width:100%;
        color: white;
    }
    .dropdown{
        margin: 20px !important;
    }

    </style>
</head>

<body>
    <div class="pusher">
        <div class="ui inverted vertical masthead center aligned segment">
            <div class="ui text container">
                <h1 class = "ui inverted header"> <i class="circular cocktail icon"></i></h1>
                <h1 class="ui inverted header">Wine.About.It </h1>
                <h3>Get yourself to drink better wine</h3>
            </div>
        </div>
    </div>
    <div class="ui page grid">
        <div class="two column row">
            <div class="column"> 
                <div class="row">
                    <div class="ui floating dropdown labeled search icon button center right floated" id="favWine">
                    <i class="heart icon"></i>
                    <span class="text">Select your favorite wine</span>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="row">                 
                    <div class="ui floating dropdown labeled search icon button center" id="newWine">
                        <i class="empty heart icon"></i>
                        <span class="text">Wine you want to like </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui one column stackable center aligned page grid">
        <div class="column twelve wide">
            <button class="ui secondary basic button" id = "button">Find my wine!</button>
        </div>
    </div>
    <div class="ui one column stackable center aligned page grid">
        <div class="column wide">
            <div class = "wine_list"></div>
        </div>
    </div>

<div id ="footer">
<center>
Jen Lamere 2016
</center>
</div>


<script src="./graphlib.min.js"></script>
<script src="./jquery-3.1.1.min.js"></script>
<script src="./similarity.js"></script>
<script src="./prototypes.js"></script>
<link rel="stylesheet" type="text/css" href="./semantic.min.css">
<script src="./semantic.min.js"></script>
<script>
    wine_prototypes_array = prototypes.split(';');
    wine_prototypes = {}
    for(var i = 0; i < wine_prototypes_array.length; i++){
        splitVals = wine_prototypes_array[i].split(',')
        wine_prototypes[splitVals[0]] = {
            "Attributes" : splitVals[1],
            "Type" : splitVals[2]
        }
    }
    console.log(wine_prototypes)
    wine = {}
    wine_names = []
    dijkstra = {}
    completed = {}

    // populate data
    var g = new graphlib.Graph();
    for (var row in data){
        wine_sim = data[row].split(',')
        if(wine[wine_sim[0]] == null){
            wine[wine_sim[0]] = {}
            wine_names.push(wine_sim[0])
        }
        if(wine[wine_sim[1]] == null){
            wine[wine_sim[1]] = {}
            wine_names.push(wine_sim[1])
        }
        wine[wine_sim[0]][wine_sim[1]] = 1-wine_sim[2]
        wine[wine_sim[1]][wine_sim[0]] = 1-wine_sim[2]
        g.setEdge(wine_sim[0], wine_sim[1], 1-wine_sim[2])
        g.setEdge(wine_sim[1], wine_sim[0], 1-wine_sim[2])

    }

    $('.ui.dropdown').dropdown();
    dropdownHTML = ""
    for(w in wine_names){
        dropdownHTML += '<div class="item" data-value="' + wine_names[w] + '">' + wine_names[w] + '</div>'
    }

    initial_wine = null
    start_wine = null
    final_wine =  null

    $('#favWine .menu').html(dropdownHTML);
    $('#favWine').dropdown({
         onChange: function(val) {
            initial_wine= val
            start_wine = val
         }
    });
    $('#newWine .menu').html(dropdownHTML);
    $('#newWine').dropdown({
         onChange: function(val) {
            final_wine = val

         }
    });

    start_wine = "Riesling";
    final_wine = "Pinot Gris/Grigio";
    initial_wine = "Riesling"
    d(start_wine, 0);

    $('#button').click(function(){
        if(!final_wine){
            $("#newWine").addClass('error');
        }
        if(!initial_wine){
            $("#favWine").addClass('error');
        }
        else if (initial_wine && final_wine){
            $("#favWine").removeClass('error');
            $("#newWine").removeClass('error');
            $("#button").addClass('loading');
            start_wine = "Riesling";
            final_wine = "Pinot Gris/Grigio";
            initial_wine = "Riesling"
            d(start_wine, 0);

        }
    })

    
    function d(start_wine, j){
        $(".wine_list").empty()
        console.log(start_wine + " " + final_wine + " " + j);
        edges = g.outEdges(start_wine)
        for(var i in edges){
            node = edges[i]['w']
            weight = wine[start_wine][node]
            if(completed[node] != null) continue

            // backtrack to final wine
            if(node == final_wine){
                wine_html = [];
                w = start_wine
                wine_html.push(final_wine);
                while(w != initial_wine){
                    wine_html.push(w);
                    w = completed[w]

                }
                wine_html.push(w)
                wine_html.reverse();
                var html = "";
                for(html_item in wine_html){
                    html += build_header(wine_html[html_item]);
                }
                $( ".wine_list" ).prepend('<div class="ui steps">' + html);
                $("#button").removeClass('loading');            
                return
            }
            else if(dijkstra[node] == null){
                dijkstra[node] = {
                    "parent":start_wine,
                    "weight": weight
                }
            }
            else if (weight < dijkstra[node][weight]){
                dijkstra[node]['parent'] = start_wine
                dijkstra[node]["weight"] = weight
            }
        }

        var min_node = {
            "weight" : 100
        }
        for(var i in dijkstra){
            if(dijkstra[i]["weight"] < min_node["weight"]){
                min_node = dijkstra[i]
                min_node["name"] = i
            }

        }
        if(min_node["weight"] == 100 || j > 20){
            console.log("no path " + j)
            return
        }

        completed[min_node["name"]] = min_node["parent"]
        delete dijkstra[min_node["name"]]
        d(min_node["name"], j + 1)
    }

    function build_header(wine_name){
      return '<div class="step"><i class="cocktail icon"></i><div class="content"><div class="title">' + wine_name + '</div><div class="description">' + wine_prototypes[wine_name]["Type"] + "<h6>" +wine_prototypes[wine_name]["Attributes"] + '</h6></div></div></div>'
      
    }
</script>
</body>
</html>